// LH4, LHA (-lh4-) extractor, no crc/sum-checks. Will extract SFX-archives as well.
// Erland Ranvinge (erland.ranvinge@gmail.com)
// Based on a mix of Nobuyasu Suehiro's Java implementation and Simon Howard's C version.
// modified version: added 1st file extraction (without having to know its name)
var LhaArrayReader=function(e){this.buffer=e,this.offset=0,this.subOffset=7};LhaArrayReader.SeekAbsolute=0,LhaArrayReader.SeekRelative=1,LhaArrayReader.prototype.readBits=function(e){for(var t=[1,2,4,8,16,32,64,128],r=this.buffer[this.offset],a=0,s=0;s<e;s++){if(a<<=1,a|=(r&t[this.subOffset])>>this.subOffset,this.subOffset--,this.subOffset<0){if(this.offset+1>=this.buffer.length)return-1;r=this.buffer[++this.offset],this.subOffset=7}}return a},LhaArrayReader.prototype.readUInt8=function(){return this.offset+1>=this.buffer.length?-1:this.buffer[this.offset++]},LhaArrayReader.prototype.readUInt16=function(){if(this.offset+2>=this.buffer.length)return-1;var e=255&this.buffer[this.offset]|this.buffer[this.offset+1]<<8&65280;return this.offset+=2,e},LhaArrayReader.prototype.readUInt32=function(){if(this.offset+4>=this.buffer.length)return-1;var e=255&this.buffer[this.offset]|this.buffer[this.offset+1]<<8&65280|this.buffer[this.offset+2]<<16&16711680|this.buffer[this.offset+3]<<24&4278190080;return this.offset+=4,e},LhaArrayReader.prototype.readString=function(e){if(this.offset+e>=this.buffer.length)return-1;for(var t="",r=0;r<e;r++)t+=String.fromCharCode(this.buffer[this.offset++]);return t},LhaArrayReader.prototype.readLength=function(){var e=this.readBits(3);if(-1==e)return-1;if(7==e)for(;0!=this.readBits(1);)e++;return e},LhaArrayReader.prototype.seek=function(e,t){switch(t){case LhaArrayReader.SeekAbsolute:this.offset=e,this.subOffset=7;break;case LhaArrayReader.SeekRelative:this.offset+=e,this.subOffset=7}},LhaArrayReader.prototype.getPosition=function(){return this.offset};var LhaArrayWriter=function(e){this.offset=0,this.size=e,this.data=new Uint8Array(e)};LhaArrayWriter.prototype.write=function(e){this.data[this.offset++]=e};var LhaTree=function(){};LhaTree.LEAF=32768,LhaTree.prototype.setConstant=function(e){this.tree[0]=e|LhaTree.LEAF},LhaTree.prototype.expand=function(){for(var e=this.allocated;this.nextEntry<e;)this.tree[this.nextEntry]=this.allocated,this.allocated+=2,this.nextEntry++},LhaTree.prototype.addCodesWithLength=function(e,t){for(var r=!0,a=0;a<e.length;a++)if(e[a]==t){var s=this.nextEntry++;this.tree[s]=a|LhaTree.LEAF}else e[a]>t&&(r=!1);return r},LhaTree.prototype.build=function(e,t){this.tree=[];for(var r=0;r<t;r++)this.tree[r]=LhaTree.LEAF;this.nextEntry=0,this.allocated=1;for(var a=0;this.expand(),a++,!this.addCodesWithLength(e,a););},LhaTree.prototype.readCode=function(e){for(var t=this.tree[0];0==(t&LhaTree.LEAF);){var r=e.readBits(1);t=this.tree[t+r]}return t&~LhaTree.LEAF};var LhaRingBuffer=function(e){this.data=[],this.size=e,this.offset=0};LhaRingBuffer.prototype.add=function(e){this.data[this.offset]=e,this.offset=(this.offset+1)%this.size},LhaRingBuffer.prototype.get=function(e,t){for(var r=this.offset+this.size-e-1,a=[],s=0;s<t;s++){var i=this.data[(r+s)%this.size];a.push(i),this.add(i)}return a};var LhaReader=function(e){if(this.reader=e,this.offsetTree=new LhaTree,this.codeTree=new LhaTree,this.ringBuffer=new LhaRingBuffer(8192),this.entries={},"MZ"==e.readString(2)){var t=e.readUInt16(),r=512*(e.readUInt16()-1)+(0!=t?t:512);e.seek(r,LhaArrayReader.SeekAbsolute)}else e.seek(0,LhaArrayReader.SeekAbsolute);for(;;){var a={};if(a.size=e.readUInt8(),a.size<=0)break;a.checksum=e.readUInt8(),a.id=e.readString(5),a.packedSize=e.readUInt32(),a.originalSize=e.readUInt32(),a.datetime=e.readUInt32(),a.attributes=e.readUInt16();var s=e.readUInt8();a.filename=e.readString(s).toLowerCase(),a.crc=e.readUInt16(),a.offset=e.getPosition(),this.entries[a.filename]=a,e.seek(a.packedSize,LhaArrayReader.SeekRelative)}};LhaReader.prototype.readTempTable=function(){var e=this.reader,t=Math.min(e.readBits(5),19);if(t<=0){var r=e.readBits(5);this.offsetTree.setConstant(r)}else{for(var a=[],s=0;s<t;s++){var i=e.readLength();if(a.push(i),2==s)for(var f=e.readBits(2);0<f--;)a.push(0),s++}this.offsetTree.build(a,38)}},LhaReader.prototype.readCodeTable=function(){var e=this.reader,t=Math.min(e.readBits(9),510);if(t<=0){var r=e.readBits(9);this.codeTree.setConstant(r)}else{for(var a=[],s=0;s<t;){var i=this.offsetTree.readCode(e);if(i<=2){var f=1;for(1==i?f=e.readBits(4)+3:2==i&&(f=e.readBits(9)+20);0<=--f;)a.push(0),s++}else a.push(i-2),s++}this.codeTree.build(a,1020)}},LhaReader.prototype.readOffsetTable=function(){var e=this.reader,t=Math.min(e.readBits(4),14);if(t<=0){var r=e.readBits(4);this.offsetTree.setConstant(r)}else{for(var a=[],s=0;s<t;s++){var i=e.readLength();a[s]=i}this.offsetTree.build(a,38)}},LhaReader.prototype.extract=function(e,t,r){null==e&&(e=Object.keys(this.entries)[0]);var a=this.entries[e];if(!a)return null;this.reader.seek(a.offset,LhaArrayReader.SeekAbsolute);var s=new LhaArrayWriter(a.originalSize),i=this;return function e(){if(i.extractBlock(s)){if(t&&t(s.offset,s.size),s.offset>=s.size)return;setTimeout(e,1)}}(),s.data},LhaReader.prototype.extractBlock=function(e){var t=this.reader,r=t.readBits(16);if(r<=0||t.offset>=t.size)return!1;this.readTempTable(),this.readCodeTable(),this.readOffsetTable();for(var a=0;a<r;a++){var s=this.codeTree.readCode(t);if(s<256)this.ringBuffer.add(s),e.write(s);else{var i=this.offsetTree.readCode(t),f=i;if(2<=i){f=t.readBits(i-1);f+=1<<i-1}var h=s-256+3,o=this.ringBuffer.get(f,h);for(var n in o)e.write(o[n])}}return!0};